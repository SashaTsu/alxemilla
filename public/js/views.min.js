function L(o){if(typeof o.price=="number")return o.price;if(!o.price)return 0;const s=String(o.price).replace(",",".").match(/\d+(\.\d+)?/);return s?Number(s[0]):0}function C(o){return o?typeof o=="string"?o:Array.isArray(o)?o.map(C).join(", "):typeof o=="object"&&o.name?o.name:String(o):""}import{fetchProducts as A,fetchProduct as j,submitOrder as P}from"./api.js";import{auth as q}from"./firebase.js";import{t as r,tColor as F}from"./locale.js";const E={logo:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.png?alt=media"},instagram:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.webp?alt=media",jpg:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.jpg?alt=media"},gmail:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.png?alt=media"},etsy:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.png?alt=media"},ravelry:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.webp?alt=media",jpg:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.jpg?alt=media"}};function I(o,s,e,l,u){return`
    <picture>
      ${o.avif?`<source srcset="${o.avif}" type="image/avif">`:""}
      ${o.webp?`<source srcset="${o.webp}" type="image/webp">`:""}
      <img src="${o.jpg||o.png}" 
           alt="${s}" 
           ${e?`class="${e}"`:""} 
           ${l?`width="${l}"`:""} 
           ${u?`height="${u}"`:""} 
           style="border-radius:8px;"
           loading="lazy" 
           decoding="async">
    </picture>
  `}function G(o){return new Promise((s,e)=>{const l=new Image;l.src=o,l.onload=()=>s({url:o,width:l.naturalWidth,height:l.naturalHeight}),l.onerror=e})}let b;export function renderSidebar(){const o=q.currentUser;document.querySelector(".sidebar").innerHTML=`
    <button class="burger-button" id="burger" aria-label="\u041C\u0435\u043D\u044E">&#9776;</button>
    <!-- 1. \u041B\u043E\u0433\u043E\u0442\u0438\u043F -->
<div class="sidebar-header">
  <a href="/">
    ${I(E.logo,"Alxemilla Logo","sidebar-logo")}
  </a>
</div>
<div class="lang-switcher">
        <button data-lang="ru" onclick="setLanguage('ru')">RU</button>
        <button data-lang="en" onclick="setLanguage('en')">EN</button>
        <button data-lang="sr" onclick="setLanguage('sr')">SR</button>
      </div>

    <!-- 2. \u041C\u0435\u043D\u044E \u0441\u043A\u0440\u043E\u043B\u043B\u0438\u0442\u0441\u044F \u043E\u0442\u0434\u0435\u043B\u044C\u043D\u043E -->
    <div class="sidebar-menu">
      <ul>
  <li><a href="/" onclick="renderProductList();return false;">${r("menu.all").toUpperCase()}</a></li>
  <li><a href="/clothing" onclick="renderProductList('clothing');return false;">${r("menu.clothing").toUpperCase()}</a></li>
  <li><a href="/bags" onclick="renderProductList('bags');return false;">${r("menu.bags").toUpperCase()}</a></li>
  <li><a href="/pattern" onclick="renderProductList('pattern');return false;">${r("menu.pattern").toUpperCase()}</a></li>
  <li><a href="/about" onclick="renderAbout();return false;">${r("menu.about").toUpperCase()}</a></li>
  <li><a href="/delivery" onclick="renderDelivery();return false;">${r("menu.delivery").toUpperCase()}</a></li>
  ${o?'<li><a href="/admin">\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0442\u043E\u0432\u0430\u0440</a></li>':""}
</ul>     
    </div>


  `}export async function renderProductList(o=null,s=!0){const e=document.getElementById("app");e.className="",s&&history.pushState({name:"list",category:o},"",o?`/${o}`:"/"),window.currentView={name:"list",category:o};const l=localStorage.getItem("lang")||"ru",u=await A(o);function n(a,c){if(!a)return"";if(a.avifUrl||a.webpUrl||a.jpegUrl)return`
      <picture>
        ${a.avifUrl?`<source srcset="${a.avifUrl}" type="image/avif">`:""}
        ${a.webpUrl?`<source srcset="${a.webpUrl}" type="image/webp">`:""}
        <img src="${a.jpegUrl||a.webpUrl||a.avifUrl}" width="${a.width}" height="${a.height}" alt="${c}" loading="lazy">
      </picture>
    `;if(a.url&&a.url.startsWith("http"))return`<img src="${a.url}" width="${a.width}" height="${a.height}" alt="${c}" loading="lazy">`;if(a.url){const d=a.url.replace(/^.*\//,"").replace(/\.\w+$/,"");return`
      <picture>
        <source srcset="/assets/images/nextgen/${d}.avif" type="image/avif" loading="lazy">
        <source srcset="/assets/images/nextgen/${d}.webp" type="image/webp" loading="lazy">
        <img src="${a.url}" width="${a.width}" height="${a.height}" alt="${c}" loading="lazy">
      </picture>
    `}return""}e.innerHTML=`
  <div class="container">
    <div class="product-grid">
      ${u.map(a=>{const c=a.image,d=a.hoverImage,f=a.translations?.[l]?.title||"";return`
<div class="card" onclick="showProduct('${a.id}');return false;">
  <div class="card-image">
    ${n(c,f)}
    ${d?n({...d,className:"hover"},f).replace("<img ",'<img class="hover" '):""}
  </div>
  <div class="card-info">
    <div class="card-title">${f}</div>
    <div class="card-price">${L(a)===0?r("product.free"):a.price}</div>
  </div>
</div>
`}).join("")}
    </div>
  </div>
  <footer class="site-credit">
    Site by <a href="https://www.linkedin.com/in/atsukanova/" target="_blank" rel="noopener">
      Aleksandra Tsukanova
    </a>
  </footer>`}export async function showProduct(o){!window.currentView||window.currentView.id;const s=document.getElementById("app");s.className="",location.pathname!==`/product/${o}`&&history.pushState({name:"product",id:o},"",`/product/${o}`),window.currentView={name:"product",id:o};const e=await j(o);if(!e)return renderProductList();const l=L(e),u=localStorage.getItem("lang")||"ru",n=e.translations?.[u]||{},a=await A();let c=[];e.group&&typeof e.group=="string"&&e.group.trim()!==""&&(c=a.filter(t=>t.group===e.group));let d="";e.group&&typeof e.group=="string"&&e.group.trim()!==""&&c.length>1?d=`
    <div class="product-colors" style="margin-bottom:16px;">
      <label style="display:block; margin-bottom:6px;">${r("product.color")||"\u0426\u0432\u0435\u0442"}</label>
      <div>
        ${c.map(t=>`<a 
  href="/product/${t.id}" 
  class="color-swatch"
  title="${F(t.color?.name||"")}"
  style="background: ${t.color?.rgb||"#eee"};"
  data-id="${t.id}"
  ${t.id===e.id?'data-active="1"':""}
></a>`).join("")}
      </div>
    </div>
  `:e.color&&e.color.rgb&&(d=`
    <div class="product-colors" style="margin-bottom:12px;">
      <label style="display:block; margin-bottom:6px;">${r("order.color")||"\u0426\u0432\u0435\u0442"}</label>
      <div>
        <span 
          class="color-swatch" 
          style="background: ${e.color.rgb}; opacity:0.7; cursor: default;" 
          title="${F(e.color?.name||"")}">
        </span>
      </div>
    </div>
  `);const f=(Array.isArray(e.images)&&e.images.length>0?e.images:[e.image,e.hoverImage]).filter(t=>t&&typeof t=="object"&&(t.avifUrl||t.webpUrl||t.jpegUrl||t.url));function U(t){if(!t)return"";if(t.avifUrl||t.webpUrl||t.jpegUrl)return`
      <div class="slider-slide">
        <picture>
          ${t.avifUrl?`<source srcset="${t.avifUrl}" type="image/avif">`:""}
          ${t.webpUrl?`<source srcset="${t.webpUrl}" type="image/webp">`:""}
          <img src="${t.jpegUrl||t.webpUrl||t.avifUrl}" width="${t.width}" height="${t.height}" alt="" loading="lazy">
        </picture>
      </div>
    `;if(t.url&&t.url.startsWith("http"))return`
      <div class="slider-slide">
        <img src="${t.url}" width="${t.width}" height="${t.height}" alt="" loading="lazy">
      </div>
    `;if(t.url){const i=t.url.replace(/^.*\//,"").replace(/\.\w+$/,"");return`
      <div class="slider-slide">
        <picture>
          <source srcset="/assets/images/nextgen/${i}.avif" type="image/avif">
          <source srcset="/assets/images/nextgen/${i}.webp" type="image/webp">
          <img src="${t.url}" width="${t.width}" height="${t.height}" alt="" loading="lazy">
        </picture>
      </div>
    `}return""}const v=e.category==="pattern";let m=null;Array.isArray(e.sizes)&&e.sizes.length>0&&(m=e.sizes.find(t=>e.stock&&Number(e.stock[t])>0)||e.sizes[0]);let h="";!v&&Array.isArray(e.sizes)&&e.sizes.length>0&&(h=`
      <div class="product-sizes">
        <label>${r("order.size")}</label>
        <select id="product-size-select">
          ${e.sizes.map(t=>`<option${t===m?" selected":""}>${t}</option>`).join("")}
        </select>
        <div class="size-stock-info" id="size-stock-info"></div>
      </div>
    `);let $=!0;e.stock&&m&&($=Number(e.stock[m])>0);let z="";v?l===0&&e.fileUrl?z=`<button id="download-btn" class="buy-button">${r("product.download").toUpperCase()}</button>`:l===0&&!e.fileUrl?z=`<div class="product-warning">${r("product.noFileUrl")||"\u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u0430 \u0434\u043B\u044F \u0441\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u044F"}</div>`:z=`<button id="buy-button" class="buy-button">${r("product.buy").toUpperCase()}</button>`:z=$?`<button id="buy-button" class="buy-button">${r("product.buy").toUpperCase()}</button>`:`<button id="buy-button" class="buy-button" data-preorder="1">${r("product.preorder").toUpperCase()||"\u041F\u0420\u0415\u0414\u0417\u0410\u041A\u0410\u0417"}</button>`;let N=`
    <div class="product-description"><p>${n.description||""}</p></div>
    <div class="product-tabs-row">
      <button class="product-tab-btn" data-tab="materials">${r("product.materials")}</button>
      <button class="product-tab-btn" data-tab="sizeChart">${r("product.sizeChart")}</button>
    </div>
  `;s.innerHTML=`
  <div class="container product-two-column">
    <div class="product-gallery-main">
      <div class="slider-container">
        <div class="slider-track">
          ${f.map(U).join("")}
        </div>
      </div>
    </div>
 <div class="product-info-block">
      <h1 class="product-title">${n.title||""}</h1>
      <p class="product-price">${l===0?r("product.free"):e.price}</p>
      <div class="product-description"><p>${n.description||""}</p></div>
      ${e.category!=="pattern"?d:""}
      ${e.category!=="pattern"?h:""}
      <div class="product-buy-tabs-wrap">
  ${z}
  <div class="product-tabs-row">
    <button class="product-tab-btn" data-tab="materials">${r("product.materials")}</button>
    <button class="product-tab-btn" data-tab="sizeChart">${r("product.sizeChart")}</button>
  </div>
</div>
      <button class="back-button" onclick="renderProductList();return false;">
        ${r("product.back")}
      </button>
    </div>
  </div>`,window.scrollTo(0,0);const T=[{key:"materials",title:r("product.materials"),content:(n.materials||"").split(`
`).join("<br>")},{key:"sizeChart",title:r("product.sizeChart"),content:(n.sizeChart||"").split(`
`).join("<br>")}];function S(t="materials"){let i=document.querySelector(".product-tab-modal");i||(i=document.createElement("div"),i.className="product-tab-modal",i.innerHTML=`
        <div class="product-tab-modal-bg"></div>
        <div class="product-tab-modal-panel">
          <button class="product-tab-modal-close" aria-label="close">&times;</button>
          <div class="product-tab-modal-header">${r("product.productInfo")||"\u0418\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u044F \u043E \u0442\u043E\u0432\u0430\u0440\u0435"}</div>
          <div class="product-tab-modal-nav"></div>
          <div class="product-tab-modal-content"></div>
        </div>
      `,document.body.appendChild(i),i.querySelector(".product-tab-modal-close").onclick=i.querySelector(".product-tab-modal-bg").onclick=()=>i.remove());const w=T.map(p=>`<button class="product-modal-tab${p.key===t?" active":""}" data-tab="${p.key}">${p.title}</button>`).join("");i.querySelector(".product-tab-modal-nav").innerHTML=w,i.querySelector(".product-tab-modal-content").innerHTML=T.find(p=>p.key===t)?.content||"",i.querySelectorAll(".product-modal-tab").forEach(p=>{p.onclick=k=>{k.stopPropagation(),S(p.dataset.tab)}})}document.querySelectorAll(".product-tab-btn").forEach(t=>{t.onclick=()=>S(t.dataset.tab)}),document.querySelectorAll(".swatch-btn").forEach(t=>{t.onclick=()=>{const i=t.dataset.id;i&&i!==o&&showProduct(i)}});const _=document.getElementById("product-size-select");if(_){let w=function(){const p=_.value,k=e.stock&&typeof e.stock[p]<"u"?Number(e.stock[p]):null;let x="";const g=document.getElementById("buy-button");k===null?(x="",g&&(g.disabled=!1,g.textContent=r("product.buy"))):k>0?(x=r("product.inStock",{count:k})||`\u0412 \u043D\u0430\u043B\u0438\u0447\u0438\u0438: ${k}`,g&&(g.disabled=!1,g.textContent=r("product.buy"))):(x=r("product.outOfStockForSize")||"\u041D\u0435\u0442 \u0432 \u043D\u0430\u043B\u0438\u0447\u0438\u0438",g&&(g.disabled=!1,g.textContent=r("product.preorder")||"\u041F\u0440\u0435\u0434\u0437\u0430\u043A\u0430\u0437",g.setAttribute("data-preorder","1"))),i&&(i.textContent=x)};const t=document.getElementById("stock-message"),i=document.getElementById("size-stock-info");_.onchange=w,w()}const B=document.getElementById("buy-button");B&&B.addEventListener("click",()=>{const t=B.dataset.preorder==="1",i=!v&&document.getElementById("product-size-select")?document.getElementById("product-size-select").value:void 0;renderOrderForm(o,i,e.color,t),window.scrollToTop&&window.scrollToTop()});const y=document.getElementById("download-btn");if(y&&e.fileUrl){let t=0;const i=1e4;y.addEventListener("click",function(w){w.preventDefault();const p=Date.now();p-t<i||y.classList.contains("loading")||(t=p,y.classList.add("loading"),y.disabled=!0,window.open(e.fileUrl,"_blank"),setTimeout(()=>{y.classList.remove("loading"),y.disabled=!1},i))})}}export async function renderOrderForm(o,s=null,e=null,l=!1){b=document.getElementById("app"),b.className="order-page",history.pushState({name:"order",id:o,size:s,color:e,preorder:l},"",`/order/${o}`),window.currentView={name:"order",id:o,size:s,color:e,preorder:l};const u=await j(o);if(!u)return renderProductList();b.innerHTML=`
  <div class="container container-narrow">
    <h1 class="order-title-label">
      ${l?r("order.preorderTitle")||"\u041E\u0444\u043E\u0440\u043C\u043B\u0435\u043D\u0438\u0435 \u043F\u0440\u0435\u0434\u0437\u0430\u043A\u0430\u0437\u0430":r("order.title")}
    </h1>
    <form id="order-form" class="order-form" novalidate>
            ${s&&s!=="undefined"?`<div class="form-field" style="margin-bottom:10px;">
          <div class="checkout-params-row">
            <span class="checkout-product-title">${u.translations?.[localStorage.getItem("lang")||"ru"]?.title||""}</span>
            <span class="checkout-size-badge">${s}</span>
          </div>
       </div>`:""}
${!s&&u.category!=="pattern"&&Array.isArray(u.sizes)&&u.sizes.length>0?`<div class="form-field">
          <label>${r("order.size")}</label>
          <select name="size">
            ${u.sizes.map(a=>`<option>${a}</option>`).join("")}
          </select>
       </div>`:""}
      <div class="form-field"><label for="name-input">${r("order.name")}</label><input id="name-input" name="name" required pattern="^[A-Za-zA-\u042F\u0430-\u044F\u0401\u0451 ]{2,}$"/><div class="field-error" id="error-name"></div></div>
      <div class="form-field"><label for="email-input">${r("order.email")}</label><input id="email-input" name="email" type="email" required/><div class="field-error" id="error-email"></div></div>
      <div class="form-field"><label for="comment-input">${r("order.comment")}</label><textarea id="comment-input" name="comment" maxlength="500"></textarea><div class="field-error" id="error-comment"></div></div>
      <div class="form-field"><div id="recaptcha-container"></div><div class="field-error" id="error-captcha"></div></div>
      <div id="order-error" class="order-error" aria-live="polite"></div>
      <button type="submit" class="buy-button">
  ${(l?r("order.confirmPreorder"):r("order.confirm")).toUpperCase()}
</button>
    </form>
    <button class="back-button" onclick="showProduct('${u.id}')">${r("product.back")}</button>
  </div>
`,document.querySelectorAll(".color-swatch").forEach(a=>{a.addEventListener("click",function(c){c.preventDefault();const d=a.getAttribute("data-id");d&&d!==u.id&&showProduct(d)})}),function a(){const c=document.getElementById("recaptcha-container");if(window.grecaptcha&&c)try{grecaptcha.render(c,{sitekey:"6LebqB8rAAAAAGu7irZmYxKl6Up_4CmFHT2Uhotk"})}catch{}else setTimeout(a,300)}();const n=document.getElementById("order-form");n.addEventListener("submit",async a=>{a.preventDefault(),n.querySelectorAll(".field-error").forEach(h=>h.textContent="");const c=n.elements.name.value.trim(),d=n.elements.email.value.trim(),f=n.elements.comment.value.trim();if(!c){document.getElementById("error-name").textContent=r("order.nameError"),document.getElementById("name-input").focus();return}if(!/^\S+@\S+\.\S+$/.test(d)){document.getElementById("error-email").textContent=r("order.emailError"),document.getElementById("email-input").focus();return}if(!f){document.getElementById("error-comment").textContent=r("order.commentError"),document.getElementById("comment-input").focus();return}if(n.elements.size&&!n.elements.size.value){alert("\u041F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0440\u0430\u0437\u043C\u0435\u0440"),n.elements.size.focus();return}const U=grecaptcha.getResponse();if(!U){document.getElementById("error-captcha").textContent=r("order.captchaError"),document.getElementById("recaptcha-container").scrollIntoView({behavior:"smooth"});return}const v=n.querySelector('button[type="submit"]');v.classList.add("loading"),v.disabled=!0;const m={name:c,email:d,comment:f,productId:o,"g-recaptcha-response":U};s?m.size=s:n.elements.size&&n.elements.size.value&&(m.size=n.elements.size.value),e&&(m.color=typeof e=="string"?e:C(e)),l&&(m.preorder=!0);try{const h=await P(m);grecaptcha.reset(),b.innerHTML=`
      <div class="container container-narrow">
        <h2 class="order-title-label">${r("order.thanksTitle")}</h2>
        <p>${r("order.thanksBody").replace("{id}",h.id)}</p>
        <button class="buy-button" onclick="renderProductList()">
          ${r("order.backToProducts")}
        </button>
      </div>
    `}catch(h){const $=h.message;$==="Invalid name"?document.getElementById("error-name").textContent=r("order.nameError"):$==="Invalid email"?document.getElementById("error-email").textContent=r("order.emailError"):$==="Invalid comment"?document.getElementById("error-comment").textContent=r("order.commentError"):alert(r("order.submitError"))}finally{v.classList.remove("loading"),v.disabled=!1}}),window.scrollToTop&&window.scrollToTop()}export function renderAbout(){history.pushState({name:"about"},"","/about"),b=document.getElementById("app"),b.className="",b.innerHTML=`
    <div class="container">
      <h1>${r("menu.about")}</h1>
      <p>${r("about.text")}</p>
<div class="about-socials" style="margin-top:24px; display:flex; gap:18px; align-items:center;">
  <a href="https://www.ravelry.com/designers/alxemilla" target="_blank" rel="noopener">
    ${I(E.ravelry,"Ravelry","",32,32)}
  </a>
  <a href="https://www.instagram.com/alxemilla/" target="_blank" rel="noopener">
    ${I(E.instagram,"Instagram","",32,32)}
  </a>
  <a href="mailto:alxemilla@gmail.com">
    ${I(E.gmail,"Email","",32,32)}
  </a>
  <a href="https://www.etsy.com/people/wkanlq89y8coffwc?ref=hdr_user_menu-profile" target="_blank" rel="noopener">
    ${I(E.etsy,"Etsy","",32,32)}
  </a>
</div>
      </div>
    </div>`,window.scrollToTop()}export function renderDelivery(){history.pushState({name:"delivery"},"","/delivery"),b=document.getElementById("app"),b.className="",b.innerHTML=`
    <div class="container">
      <h1>${r("menu.delivery")}</h1>
      <p>${r("delivery.text").split(`

`).join("</p><p>")}</p>
    </div>`,window.scrollToTop()}window.renderDelivery=renderDelivery;
