function getPriceNumber(e){if("number"==typeof e.price)return e.price;if(!e.price)return 0;const t=String(e.price).replace(",",".").match(/\d+(\.\d+)?/);return t?Number(t[0]):0}function getColorTitle(e){return e?"string"==typeof e?e:Array.isArray(e)?e.map(getColorTitle).join(", "):"object"==typeof e&&e.name?e.name:String(e):""}import{fetchProducts,fetchProduct,submitOrder,addOrUpdateProduct}from"./api.js";import{auth,signInWithEmailAndPassword,signOut}from"./firebase.js";import{t,tColor,tFormat}from"./locale.js";const ASSETS={logo:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Flogo.png?alt=media"},instagram:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.webp?alt=media",jpg:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Finstagram.jpg?alt=media"},gmail:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fgmail.png?alt=media"},etsy:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.webp?alt=media",png:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fetsy.png?alt=media"},ravelry:{avif:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.avif?alt=media",webp:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.webp?alt=media",jpg:"https://firebasestorage.googleapis.com/v0/b/knitting-shop-7526c.firebasestorage.app/o/icons_and_logo%2Fravelry.jpg?alt=media"}};function pictureHTML(e,t,r,n,o){return`\n    <picture>\n      ${e.avif?`<source srcset="${e.avif}" type="image/avif">`:""}\n      ${e.webp?`<source srcset="${e.webp}" type="image/webp">`:""}\n      <img src="${e.jpg||e.png}" \n           alt="${t}" \n           ${r?`class="${r}"`:""} \n           ${n?`width="${n}"`:""} \n           ${o?`height="${o}"`:""} \n           style="border-radius:8px;"\n           loading="lazy" \n           decoding="async">\n    </picture>\n  `}function getImageMeta(e){return new Promise(((t,r)=>{const n=new Image;n.src=e,n.onload=()=>t({url:e,width:n.naturalWidth,height:n.naturalHeight}),n.onerror=r}))}let app;export function renderSidebar(){const e=auth.currentUser;document.querySelector(".sidebar").innerHTML=`\n    <button class="burger-button" id="burger" aria-label="Меню">&#9776;</button>\n    \x3c!-- 1. Логотип --\x3e\n<div class="sidebar-header">\n  <a href="/">\n    ${pictureHTML(ASSETS.logo,"Alxemilla Logo","sidebar-logo")}\n  </a>\n</div>\n<div class="lang-switcher">\n        <button data-lang="ru" onclick="setLanguage('ru')">RU</button>\n        <button data-lang="en" onclick="setLanguage('en')">EN</button>\n        <button data-lang="sr" onclick="setLanguage('sr')">SR</button>\n      </div>\n\n    \x3c!-- 2. Меню, будет скроллиться отдельно --\x3e\n    <div class="sidebar-menu">\n      <ul>\n  <li><a href="/" onclick="renderProductList();return false;">${t("menu.all").toUpperCase()}</a></li>\n  <li><a href="/clothing" onclick="renderProductList('clothing');return false;">${t("menu.clothing").toUpperCase()}</a></li>\n  <li><a href="/bags" onclick="renderProductList('bags');return false;">${t("menu.bags").toUpperCase()}</a></li>\n  <li><a href="/pattern" onclick="renderProductList('pattern');return false;">${t("menu.pattern").toUpperCase()}</a></li>\n  <li><a href="/about" onclick="renderAbout();return false;">${t("menu.about").toUpperCase()}</a></li>\n  <li><a href="/delivery" onclick="renderDelivery();return false;">${t("menu.delivery").toUpperCase()}</a></li>\n  ${e?'<li><a href="/admin">Добавить товар</a></li>':""}\n</ul>     \n    </div>\n\n\n  `}export async function renderProductList(e=null,r=!0){const n=document.getElementById("app");n.className="",r&&history.pushState({name:"list",category:e},"",e?`/${e}`:"/"),window.currentView={name:"list",category:e};const o=localStorage.getItem("lang")||"ru",a=await fetchProducts(e);function i(e,t){if(!e)return"";if(e.avifUrl||e.webpUrl||e.jpegUrl)return`\n      <picture>\n        ${e.avifUrl?`<source srcset="${e.avifUrl}" type="image/avif">`:""}\n        ${e.webpUrl?`<source srcset="${e.webpUrl}" type="image/webp">`:""}\n        <img src="${e.jpegUrl||e.webpUrl||e.avifUrl}" width="${e.width}" height="${e.height}" alt="${t}" loading="lazy">\n      </picture>\n    `;if(e.url&&e.url.startsWith("http"))return`<img src="${e.url}" width="${e.width}" height="${e.height}" alt="${t}" loading="lazy">`;if(e.url){const r=e.url.replace(/^.*\//,"").replace(/\.\w+$/,"");return`\n      <picture>\n        <source srcset="/assets/images/nextgen/${r}.avif" type="image/avif" loading="lazy">\n        <source srcset="/assets/images/nextgen/${r}.webp" type="image/webp" loading="lazy">\n        <img src="${e.url}" width="${e.width}" height="${e.height}" alt="${t}" loading="lazy">\n      </picture>\n    `}return""}n.innerHTML=`\n  <div class="container">\n    <div class="product-grid">\n      ${a.map((e=>{const r=e.image,n=e.hoverImage,a=e.translations?.[o]?.title||"";return`\n<div class="card" onclick="showProduct('${e.id}');return false;">\n  <div class="card-image">\n    ${i(r,a)}\n    ${n?i({...n,className:"hover"},a).replace("<img ",'<img class="hover" '):""}\n  </div>\n  <div class="card-info">\n    <div class="card-title">${a}</div>\n    <div class="card-price">${0===getPriceNumber(e)?t("product.free"):e.price}</div>\n  </div>\n</div>\n`})).join("")}\n    </div>\n  </div>\n  <footer class="site-credit">\n    Site by <a href="https://www.linkedin.com/in/atsukanova/" target="_blank" rel="noopener">\n      Aleksandra Tsukanova\n    </a>\n  </footer>`}export async function showProduct(e){!window.currentView||window.currentView.id;const r=document.getElementById("app");r.className="",location.pathname!==`/product/${e}`&&history.pushState({name:"product",id:e},"",`/product/${e}`),window.currentView={name:"product",id:e};const n=await fetchProduct(e);if(!n)return renderProductList();const o=getPriceNumber(n),a=localStorage.getItem("lang")||"ru",i=n.translations?.[a]||{},s=await fetchProducts();let l=[];n.group&&"string"==typeof n.group&&""!==n.group.trim()&&(l=s.filter((e=>e.group===n.group)));let c="";n.group&&"string"==typeof n.group&&""!==n.group.trim()&&l.length>1?c=`\n    <div class="product-colors" style="margin-bottom:16px;">\n      <label style="display:block; margin-bottom:6px;">${t("product.color")||"Цвет"}</label>\n      <div>\n        ${l.map((e=>`<a \n  href="/product/${e.id}" \n  class="color-swatch"\n  title="${tColor(e.color?.name||"")}"\n  style="background: ${e.color?.rgb||"#eee"};"\n  data-id="${e.id}"\n  ${e.id===n.id?'data-active="1"':""}\n></a>`)).join("")}\n      </div>\n    </div>\n  `:n.color&&n.color.rgb&&(c=`\n    <div class="product-colors" style="margin-bottom:12px;">\n      <label style="display:block; margin-bottom:6px;">${t("order.color")||"Цвет"}</label>\n      <div>\n        <span \n          class="color-swatch" \n          style="background: ${n.color.rgb}; opacity:0.7; cursor: default;" \n          title="${tColor(n.color?.name||"")}">\n        </span>\n      </div>\n    </div>\n  `);const d=(Array.isArray(n.images)&&n.images.length>0?n.images:[n.image,n.hoverImage]).filter((e=>e&&"object"==typeof e&&(e.avifUrl||e.webpUrl||e.jpegUrl||e.url)));const p="pattern"===n.category;let u=null;Array.isArray(n.sizes)&&n.sizes.length>0&&(u=n.sizes.find((e=>n.stock&&Number(n.stock[e])>0))||n.sizes[0]);let m="";!p&&Array.isArray(n.sizes)&&n.sizes.length>0&&(m=`\n      <div class="product-sizes">\n        <label>${t("order.size")}</label>\n        <select id="product-size-select">\n          ${n.sizes.map((e=>`<option${e===u?" selected":""}>${e}</option>`)).join("")}\n        </select>\n        <div class="size-stock-info" id="size-stock-info"></div>\n      </div>\n    `);let g=!0;n.stock&&u&&(g=Number(n.stock[u])>0);let b="";b=p?0===o&&n.fileUrl?`<button id="download-btn" class="buy-button">${t("product.download").toUpperCase()}</button>`:0!==o||n.fileUrl?`<button id="buy-button" class="buy-button">${t("product.buy").toUpperCase()}</button>`:`<div class="product-warning">${t("product.noFileUrl")||"Нет файла для скачивания"}</div>`:g?`<button id="buy-button" class="buy-button">${t("product.buy").toUpperCase()}</button>`:`<button id="buy-button" class="buy-button" data-preorder="1">${t("product.preorder").toUpperCase()||"ПРЕДЗАКАЗ"}</button>`;i.description,t("product.materials"),t("product.sizeChart");r.innerHTML=`\n  <div class="container product-two-column">\n    <div class="product-gallery-main">\n      <div class="slider-container">\n        <div class="slider-track">\n          ${d.map((function(e){if(!e)return"";if(e.avifUrl||e.webpUrl||e.jpegUrl)return`\n      <div class="slider-slide">\n        <picture>\n          ${e.avifUrl?`<source srcset="${e.avifUrl}" type="image/avif">`:""}\n          ${e.webpUrl?`<source srcset="${e.webpUrl}" type="image/webp">`:""}\n          <img src="${e.jpegUrl||e.webpUrl||e.avifUrl}" width="${e.width}" height="${e.height}" alt="" loading="lazy">\n        </picture>\n      </div>\n    `;if(e.url&&e.url.startsWith("http"))return`\n      <div class="slider-slide">\n        <img src="${e.url}" width="${e.width}" height="${e.height}" alt="" loading="lazy">\n      </div>\n    `;if(e.url){const t=e.url.replace(/^.*\//,"").replace(/\.\w+$/,"");return`\n      <div class="slider-slide">\n        <picture>\n          <source srcset="/assets/images/nextgen/${t}.avif" type="image/avif">\n          <source srcset="/assets/images/nextgen/${t}.webp" type="image/webp">\n          <img src="${e.url}" width="${e.width}" height="${e.height}" alt="" loading="lazy">\n        </picture>\n      </div>\n    `}return""})).join("")}\n        </div>\n      </div>\n    </div>\n <div class="product-info-block">\n      <h1 class="product-title">${i.title||""}</h1>\n      <p class="product-price">${0===o?t("product.free"):n.price}</p>\n      <div class="product-description"><p>${i.description||""}</p></div>\n      ${"pattern"!==n.category?c:""}\n      ${"pattern"!==n.category?m:""}\n      <div class="product-buy-tabs-wrap">\n  ${b}\n  <div class="product-tabs-row">\n    <button class="product-tab-btn" data-tab="materials">${t("product.materials")}</button>\n    <button class="product-tab-btn" data-tab="sizeChart">${t("product.sizeChart")}</button>\n  </div>\n</div>\n      <button class="back-button" onclick="renderProductList();return false;">\n        ${t("product.back")}\n      </button>\n    </div>\n  </div>`,window.scrollTo(0,0);const v=[{key:"materials",title:t("product.materials"),content:(i.materials||"").split("\n").join("<br>")},{key:"sizeChart",title:t("product.sizeChart"),content:(i.sizeChart||"").split("\n").join("<br>")}];function f(e="materials"){let r=document.querySelector(".product-tab-modal");r||(r=document.createElement("div"),r.className="product-tab-modal",r.innerHTML=`\n        <div class="product-tab-modal-bg"></div>\n        <div class="product-tab-modal-panel">\n          <button class="product-tab-modal-close" aria-label="close">&times;</button>\n          <div class="product-tab-modal-header">${t("product.productInfo")||"Информация о товаре"}</div>\n          <div class="product-tab-modal-nav"></div>\n          <div class="product-tab-modal-content"></div>\n        </div>\n      `,document.body.appendChild(r),r.querySelector(".product-tab-modal-close").onclick=r.querySelector(".product-tab-modal-bg").onclick=()=>r.remove());const n=v.map((t=>`<button class="product-modal-tab${t.key===e?" active":""}" data-tab="${t.key}">${t.title}</button>`)).join("");r.querySelector(".product-tab-modal-nav").innerHTML=n,r.querySelector(".product-tab-modal-content").innerHTML=v.find((t=>t.key===e))?.content||"",r.querySelectorAll(".product-modal-tab").forEach((e=>{e.onclick=t=>{t.stopPropagation(),f(e.dataset.tab)}}))}document.querySelectorAll(".product-tab-btn").forEach((e=>{e.onclick=()=>f(e.dataset.tab)})),document.querySelectorAll(".swatch-btn").forEach((t=>{t.onclick=()=>{const r=t.dataset.id;r&&r!==e&&showProduct(r)}}));const h=document.getElementById("product-size-select");if(h){document.getElementById("stock-message");const k=document.getElementById("size-stock-info");function y(){const e=h.value,r=n.stock&&void 0!==n.stock[e]?Number(n.stock[e]):null;let o="";const a=document.getElementById("buy-button");null===r?(o="",a&&(a.disabled=!1,a.textContent=t("product.buy"))):r>0?(o=t("product.inStock",{count:r})||`В наличии: ${r}`,a&&(a.disabled=!1,a.textContent=t("product.buy"))):(o=t("product.outOfStockForSize")||"Нет в наличии",a&&(a.disabled=!1,a.textContent=t("product.preorder")||"Предзаказ",a.setAttribute("data-preorder","1"))),k&&(k.textContent=o)}h.onchange=y,y()}const $=document.getElementById("buy-button");$&&$.addEventListener("click",(()=>{const t="1"===$.dataset.preorder,r=!p&&document.getElementById("product-size-select")?document.getElementById("product-size-select").value:void 0;renderOrderForm(e,r,n.color,t),window.scrollToTop&&window.scrollToTop()}));const w=document.getElementById("download-btn");if(w&&n.fileUrl){let E=0;const z=1e4;w.addEventListener("click",(function(e){e.preventDefault();const t=Date.now();t-E<z||w.classList.contains("loading")||(E=t,w.classList.add("loading"),w.disabled=!0,window.open(n.fileUrl,"_blank"),setTimeout((()=>{w.classList.remove("loading"),w.disabled=!1}),z))}))}}export async function renderOrderForm(e,r=null,n=null,o=!1){app=document.getElementById("app"),app.className="order-page",history.pushState({name:"order",id:e,size:r,color:n,preorder:o},"",`/order/${e}`),window.currentView={name:"order",id:e,size:r,color:n,preorder:o};const a=await fetchProduct(e);if(!a)return renderProductList();app.innerHTML=`\n  <div class="container container-narrow">\n    <h1 class="order-title-label">\n      ${o?t("order.preorderTitle")||"Оформление предзаказа":t("order.title")}\n    </h1>\n    <form id="order-form" class="order-form" novalidate>\n            ${r&&"undefined"!==r?`<div class="form-field" style="margin-bottom:10px;">\n          <div class="checkout-params-row">\n            <span class="checkout-product-title">${a.translations?.[localStorage.getItem("lang")||"ru"]?.title||""}</span>\n            <span class="checkout-size-badge">${r}</span>\n          </div>\n       </div>`:""}\n${!r&&"pattern"!==a.category&&Array.isArray(a.sizes)&&a.sizes.length>0?`<div class="form-field">\n          <label>${t("order.size")}</label>\n          <select name="size">\n            ${a.sizes.map((e=>`<option>${e}</option>`)).join("")}\n          </select>\n       </div>`:""}\n      <div class="form-field"><label for="name-input">${t("order.name")}</label><input id="name-input" name="name" required pattern="^[A-Za-zA-Яа-яЁё ]{2,}$"/><div class="field-error" id="error-name"></div></div>\n      <div class="form-field"><label for="email-input">${t("order.email")}</label><input id="email-input" name="email" type="email" required/><div class="field-error" id="error-email"></div></div>\n      <div class="form-field"><label for="comment-input">${t("order.comment")}</label><textarea id="comment-input" name="comment" maxlength="500"></textarea><div class="field-error" id="error-comment"></div></div>\n      <div class="form-field"><div id="recaptcha-container"></div><div class="field-error" id="error-captcha"></div></div>\n      <div id="order-error" class="order-error" aria-live="polite"></div>\n      <button type="submit" class="buy-button">\n  ${t(o?"order.confirmPreorder":"order.confirm").toUpperCase()}\n</button>\n    </form>\n    <button class="back-button" onclick="showProduct('${a.id}')">${t("product.back")}</button>\n  </div>\n`,document.querySelectorAll(".color-swatch").forEach((e=>{e.addEventListener("click",(function(t){t.preventDefault();const r=e.getAttribute("data-id");r&&r!==a.id&&showProduct(r)}))})),function e(){const t=document.getElementById("recaptcha-container");if(window.grecaptcha&&t)try{grecaptcha.render(t,{sitekey:"6LebqB8rAAAAAGu7irZmYxKl6Up_4CmFHT2Uhotk"})}catch{}else setTimeout(e,300)}();const i=document.getElementById("order-form");i.addEventListener("submit",(async a=>{a.preventDefault(),i.querySelectorAll(".field-error").forEach((e=>e.textContent=""));const s=i.elements.name.value.trim(),l=i.elements.email.value.trim(),c=i.elements.comment.value.trim();if(!s)return document.getElementById("error-name").textContent=t("order.nameError"),void document.getElementById("name-input").focus();if(!/^\S+@\S+\.\S+$/.test(l))return document.getElementById("error-email").textContent=t("order.emailError"),void document.getElementById("email-input").focus();if(!c)return document.getElementById("error-comment").textContent=t("order.commentError"),void document.getElementById("comment-input").focus();if(i.elements.size&&!i.elements.size.value)return alert("Пожалуйста, выберите размер"),void i.elements.size.focus();const d=grecaptcha.getResponse();if(!d)return document.getElementById("error-captcha").textContent=t("order.captchaError"),void document.getElementById("recaptcha-container").scrollIntoView({behavior:"smooth"});const p=i.querySelector('button[type="submit"]');p.classList.add("loading"),p.disabled=!0;const u={name:s,email:l,comment:c,productId:e,"g-recaptcha-response":d};r?u.size=r:i.elements.size&&i.elements.size.value&&(u.size=i.elements.size.value),n&&(u.color="string"==typeof n?n:getColorTitle(n)),o&&(u.preorder=!0);try{const e=await submitOrder(u);grecaptcha.reset(),app.innerHTML=`\n      <div class="container container-narrow">\n        <h2 class="order-title-label">${t("order.thanksTitle")}</h2>\n        <p>${t("order.thanksBody").replace("{id}",e.id)}</p>\n        <button class="buy-button" onclick="renderProductList()">\n          ${t("order.backToProducts")}\n        </button>\n      </div>\n    `}catch(a){const e=a.message;"Invalid name"===e?document.getElementById("error-name").textContent=t("order.nameError"):"Invalid email"===e?document.getElementById("error-email").textContent=t("order.emailError"):"Invalid comment"===e?document.getElementById("error-comment").textContent=t("order.commentError"):alert(t("order.submitError"))}finally{p.classList.remove("loading"),p.disabled=!1}})),window.scrollToTop&&window.scrollToTop()}export function renderAbout(){history.pushState({name:"about"},"","/about"),app=document.getElementById("app"),app.className="",app.innerHTML=`\n    <div class="container">\n      <h1>${t("menu.about")}</h1>\n      <p>${t("about.text")}</p>\n<div class="about-socials" style="margin-top:24px; display:flex; gap:18px; align-items:center;">\n  <a href="https://www.ravelry.com/designers/alxemilla" target="_blank" rel="noopener">\n    ${pictureHTML(ASSETS.ravelry,"Ravelry","",32,32)}\n  </a>\n  <a href="https://www.instagram.com/alxemilla/" target="_blank" rel="noopener">\n    ${pictureHTML(ASSETS.instagram,"Instagram","",32,32)}\n  </a>\n  <a href="mailto:alxemilla@gmail.com">\n    ${pictureHTML(ASSETS.gmail,"Email","",32,32)}\n  </a>\n  <a href="https://www.etsy.com/people/wkanlq89y8coffwc?ref=hdr_user_menu-profile" target="_blank" rel="noopener">\n    ${pictureHTML(ASSETS.etsy,"Etsy","",32,32)}\n  </a>\n</div>\n      </div>\n    </div>`,window.scrollToTop()}export function renderDelivery(){history.pushState({name:"delivery"},"","/delivery"),app=document.getElementById("app"),app.className="",app.innerHTML=`\n    <div class="container">\n      <h1>${t("menu.delivery")}</h1>\n      <p>${t("delivery.text").split("\n\n").join("</p><p>")}</p>\n    </div>`,window.scrollToTop()}window.renderDelivery=renderDelivery;